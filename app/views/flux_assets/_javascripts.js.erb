/*! ----------------------------------------------------------------------------
* _javascripts.js.erb
* Copyright 2010 wollzelle GmbH (http://wollzelle.com). All rights reserved.
* --------------------------------------------------------------------------- */

$(function() {

  /* tag filter
  ------------------------------------- */

  $('#flux-tags input').click(function(e){      
    var el = $(e.target);
    var tag = $(e.target).attr('value');

    $('#flux-tags label').removeClass('active');
    el.parent('label').addClass('active');      

    $('#flux-assets li').hide();
    $('#flux-assets li.' + tag ).show();
  });

  /* make images selectable
  ------------------------------------- */  

  // $('#flux-assets ol').selectable({
  //   filter: '.flux-asset:visible',
  //   stop:   updateSelectedCount
  // });
  
  $('.flux-asset').click(function(e){
    $(this).toggleClass('ui-selected');
    updateSelectedCount();
  });

  $('#flux-clear-button').click(function(e){      
    e.preventDefault();      
    var button = $('#flux-use-button');
    $('.flux-asset').removeClass('ui-selected');
    button.val(button.data('default-text'));
  });

  function updateSelectedCount() {
    var button = $('#flux-use-button');
    var count = $('#flux-assets .ui-selected').size();
    button.val(button.data('default-text') + ' (' + count + ')');
  }

  /* return selected images to gallery
  ------------------------------------- */

  $('#flux-form').submit(function(e){

    e.preventDefault();

    var data = [];
    var selected = $('#flux-assets .ui-selected img');

    selected.each(function(idx, item){

      var item = $(item);
      var img = {};

      img.public_url = item.attr('data-public-url');
      img.description = item.attr('data-description');        

      data.push(img);        
    });        

    parent.$(parent.document).trigger('flux:updateGallery', [data]);

  });            

});